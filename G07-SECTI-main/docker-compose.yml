# A linha 'version' é obsoleta, pode ser removida
services:
  # Renomeei o serviço para 'api' para manter a consistência com os comandos exec, mas 'backend' também funciona
  api:
    container_name: app_backend
    build: ./backend 
    ports:
      - "3333:3333"

    volumes:
      - ./backend:/usr/app
      # Preserva node_modules instalado na imagem (evita que o bind mount do host o sobrescreva)
      - /usr/app/node_modules

    # Evita erro de permissão no entrypoint devido ao bind mount; executa via shell
    entrypoint: ["sh", "./entrypoint.sh"]
    command: ["npm", "run", "dev"]

    depends_on:
      db:
        condition: service_healthy
    environment:
      - APP_PORT=3333
      - JWT_SECRET=jwt_secret
      - DATABASE_USER=sukatech_user
      - DATABASE_PASSWORD=sukatech_password
      - DATABASE_HOST=db
      - DATABASE_PORT=3306
      - DATABASE_NAME=sukatechdb
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3333/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  db:
    image: mysql:8.0
    container_name: sukatech_mysql
    ports:
      - "3307:3306" # Lembre-se que para acessar de fora, agora é a porta 3307
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 10s
      retries: 5
    environment:
      - MYSQL_ROOT_PASSWORD=root_password_super_secreta
      - MYSQL_DATABASE=sukatechdb
      - MYSQL_USER=sukatech_user
      - MYSQL_PASSWORD=sukatech_password
    volumes:
      - ./mysql_data:/var/lib/mysql