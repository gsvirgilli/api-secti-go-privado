import { describe, it, expect, beforeAll, afterAll, vi } from 'vitest';
import request from 'supertest';
import { app } from '../src/app.js';

// Mock do JWT para autenticação
vi.mock('../src/utils/jwt.js', () => ({
  verifyJwt: vi.fn().mockReturnValue({
    id: 1,
    nome: 'Test User',
    email: 'test@example.com',
    role: 'ADMIN'
  }),
  generateJwt: vi.fn().mockReturnValue('mock-jwt-token-123')
}));

// Mock do middleware de autenticação
vi.mock('../src/middlewares/isAuthenticated.js', () => ({
  isAuthenticated: vi.fn().mockImplementation((req, res, next) => {
    const authHeader = req.headers.authorization;
    
    // Se não tem header de autorização, retorna 401
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return res.status(401).json({ message: 'Unauthorized' });
    }
    
    const token = authHeader.replace('Bearer ', '').trim();
    
    // Se token é inválido, retorna 401
    if (token === 'invalid-token') {
      return res.status(401).json({ message: 'Invalid token' });
    }
    
    // Se token é válido, simular usuário autenticado
    req.user = {
      id: 1,
      nome: 'Test User',
      email: 'test@example.com',
      role: 'ADMIN'
    };
    next();
  })
}));

// Mock do CourseService para evitar uso do banco real
vi.mock('../src/modules/courses/course.service.js', () => {
  return {
    default: {
      findAll: vi.fn().mockResolvedValue([
        {
          id: 1,
          nome: 'React Básico',
          carga_horaria: 40,
          descricao: 'Curso de React para iniciantes',
          createdAt: new Date(),
          updatedAt: new Date()
        }
      ]),
      findById: vi.fn().mockImplementation((id) => {
        if (id === '999' || id === 999) {
          const error = new Error('Curso não encontrado');
          (error as any).statusCode = 404;
          throw error;
        }
        return Promise.resolve({
          id: 1,
          nome: 'React Básico',
          carga_horaria: 40,
          descricao: 'Curso de React para iniciantes',
          createdAt: new Date(),
          updatedAt: new Date()
        });
      }),
      create: vi.fn().mockImplementation((courseData) => Promise.resolve({
        id: 2,
        nome: courseData.nome,
        carga_horaria: courseData.carga_horaria,
        descricao: courseData.descricao,
        createdAt: new Date(),
        updatedAt: new Date()
      })),
      update: vi.fn().mockResolvedValue({
        id: 1,
        nome: 'React Avançado',
        carga_horaria: 50,
        descricao: 'Curso de React para desenvolvedores experientes',
        createdAt: new Date(),
        updatedAt: new Date()
      }),
      delete: vi.fn().mockResolvedValue(true),
      getStatistics: vi.fn().mockResolvedValue({
        total: 3,
        totalCargaHoraria: 150,
        mediaCargaHoraria: 50
      })
    }
  };
});

// Mock do UserService para autenticação
vi.mock('../src/modules/users/user.service.js', () => {
  return {
    default: {
      register: vi.fn().mockResolvedValue({
        id: 1,
        nome: 'Test User',
        email: 'test@example.com',
        role: 'ADMIN'
      }),
      login: vi.fn().mockResolvedValue({
        user: {
          id: 1,
          nome: 'Test User',
          email: 'test@example.com',
          role: 'ADMIN'
        },
        token: 'mock-jwt-token-123'
      })
    }
  };
});

describe('Courses API - Mocked Tests', () => {
  let authToken: string = 'mock-jwt-token-123';

  describe('Autenticação', () => {
    it('deve retornar erro 401 sem token', async () => {
      const response = await request(app)
        .get('/api/courses');

      expect(response.status).toBe(401);
    });

    it('deve retornar erro 401 com token inválido', async () => {
      const response = await request(app)
        .get('/api/courses')
        .set('Authorization', 'Bearer invalid-token');

      expect(response.status).toBe(401);
    });
  });

  describe('CRUD Básico', () => {
    it('deve listar cursos', async () => {
      const response = await request(app)
        .get('/api/courses')
        .set('Authorization', `Bearer ${authToken}`);

      expect(response.status).toBe(200);
      expect(response.body).toHaveProperty('success');
      expect(response.body).toHaveProperty('data');
      expect(Array.isArray(response.body.data)).toBe(true);
    });

    it('deve criar um curso com dados válidos', async () => {
      const courseData = {
        nome: 'Vue.js Básico',
        carga_horaria: 30,
        descricao: 'Curso introdutório de Vue.js'
      };

      const response = await request(app)
        .post('/api/courses')
        .set('Authorization', `Bearer ${authToken}`)
        .send(courseData);

      expect(response.status).toBe(201);
      expect(response.body.success).toBe(true);
      expect(response.body.data.nome).toBe(courseData.nome);
    });

    it('deve retornar erro 400 para dados inválidos', async () => {
      const response = await request(app)
        .post('/api/courses')
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          // nome é obrigatório, mas não está sendo enviado
          carga_horaria: 30
        });

      expect(response.status).toBe(400);
    });

    it('deve retornar estatísticas', async () => {
      const response = await request(app)
        .get('/api/courses/statistics')
        .set('Authorization', `Bearer ${authToken}`);

      expect(response.status).toBe(200);
      expect(response.body.success).toBe(true);
      expect(response.body.data).toHaveProperty('total');
    });
  });

  describe('Validações', () => {
    it('deve retornar erro 400 para ID inválido', async () => {
      const response = await request(app)
        .get('/api/courses/invalid-id')
        .set('Authorization', `Bearer ${authToken}`);

      expect(response.status).toBe(400);
    });

    it('deve retornar erro 404 para ID inexistente', async () => {
      const response = await request(app)
        .get('/api/courses/999')
        .set('Authorization', `Bearer ${authToken}`);

      expect(response.status).toBe(404);
    });
  });
});